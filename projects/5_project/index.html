<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Bayesian Spatial Modeling of Cancer Incidence (BYM2 Model) | Jongmin Mun</title> <meta name="author" content="Jongmin Mun"> <meta name="description" content="Based on ch 15, 16 of BDA3, we run Bayesian GLM with spatial random effect on Manhattan breast cancer incidence."> <meta name="keywords" content="Jongmin Mun, USC"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="stylesheet" href="/assets/css/main.css?v=1770615370"> <link rel="canonical" href="https://jong-min-moon.github.io/projects/5_project/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Jongmin </span>Mun</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">Posts</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Bayesian Spatial Modeling of Cancer Incidence (BYM2 Model)</h1> <p class="post-description">Based on ch 15, 16 of BDA3, we run Bayesian GLM with spatial random effect on Manhattan breast cancer incidence.</p> </header> <article> <p>This project was conducted for the STA6160 class at Yonsei University in Spring 2018.</p> <h2 id="part-1-theoretical-framework">Part 1: Theoretical Framework</h2> <p>This analysis employs a <strong>Generalized Linear Model (GLM)</strong> framework with <strong>Bayesian Hierarchical Spatial Random Effects</strong> using a <strong>Conditional Autoregressive Normal Prior (CAR Normal)</strong>. This approach enables us to model disease relative risk while incorporating local risk factors, such as pollution and socio-economic status, as well as accounting for the spatial dependencies inherent in geographic data.</p> <h3 id="1-the-generalized-linear-model-glm">1. The Generalized Linear Model (GLM)</h3> <p>GLM assumes the distribution of the response variable belongs to an <strong>exponential family</strong>, a collection of distributions with a specific density form, characterized by cumulant generating function.</p> <ul> <li> <strong>Likelihood (Poisson Regression):</strong> Since we are modeling the count of cancer incidence in each area , we model as a Poisson distribution: \(Y_i \sim \text{Poisson}(\lambda_i)\)</li> </ul> <p>where is the expected count of cases in area .</p> <ul> <li> <strong>Link Function:</strong> The GLM models the relationship between the expected value and the linear predictors using a <strong>link function</strong>. For Poisson regression, we use the <strong>log link</strong>: \(\log(\lambda_i) = \eta_i\)</li> </ul> <p>This is often called a “log-linear model.” The exponentiated coefficients ($e^\beta$) represent the multiplicative change in the expected count for a one-unit increase in the predictor.</p> <h3 id="2-the-offset-variable">2. The Offset Variable</h3> <p>To model the cancer <strong>rate</strong> (risk) rather than the raw count, we introduce an <strong>offset term</strong>, (Expected Cases). \(\log(\lambda_i) = \log(E_i) + \alpha + \mathbf{X}_i\boldsymbol{\beta} + \psi_i\)</p> <ul> <li> <strong>Role of Offset:</strong> represents the known “background” population size or age-adjusted expected count. It is added as a constant (coefficient fixed at 1) to the linear predictor.</li> <li> <strong>Assumption:</strong> Using an offset implies that doubling the population size leads to a doubling of the count outcome.</li> <li> <strong>Interpretation:</strong> The exponentiated regression coefficients now describe how predictors modify the <strong>relative risk</strong> compared to the expected background rate.</li> </ul> <h3 id="3-spatial-random-effects-the-bym-model">3. Spatial Random Effects (The BYM Model)</h3> <p>Random effects or hierarchical models model correlations across units. They arise in linear modeling to avoid <strong>pseudo-replication</strong>: the error of treating units that are non-IID (independent and identically distributed) as if they were IID. Units often have a hierarchically clustered structure, such as students belonging to classes, schools, and districts. Students in the same class are distinct entities, but they share common environmental factors, so they are not fully independent. Another example is spatial correlation: adjacent states, such as California and Oregon, are distinct entities but share common geographical features, meaning they are not truly IID.</p> <p>Hierarchical models address this by assigning regression coefficients (random effects) to the indicator variables for this correlation structure (e.g., the specific group or region). Crucially, these coefficients share the same nontrivial hyperparameter (e.g. variance). This shared distribution allows the model to <strong>borrow strength</strong> within groups. Estimates for groups with sparse data are stabilized by being pulled toward the group mean, effectively using information from the wider population to improve unit inference with small data.</p> <p>Through this mechanism, the model achieves <strong>partial pooling</strong>. It is a good compromise between two extremes:</p> <ul> <li> <strong>no pooling</strong>: assuming independece and non-identity across units, just include indicator variables as predictors, without hieararchical structure. This corresponds to setting the variance of prior as \(\infty\).</li> <li> <strong>complete pooling</strong>: assuming iid across units. Not inclduing indicator variables as predictors. This corresponds to setting the variance of effects as zero.</li> </ul> <p>Geographical data is rarely independent; high-cancer areas tend to cluster. To capture this <strong>spatial dependence</strong>, we introduce a random effect term into the linear predictor. In the <strong>Besag-York-Mollié (BYM)</strong> framework, this random effect is split into two components:</p> \[\psi_i = \underbrace{u_i}_{\text{Spatial (Structured)}} + \underbrace{v_i}_{\text{Noise (Unstructured)}}\] <h4 id="the-spatial-component-u_i">The Spatial Component ($u_i$)</h4> <p>The spatial component is modeled using a <strong>Conditional Autoregressive (CAR)</strong> prior. This allows each area to “borrow strength” from its neighbors.</p> <ul> <li><strong>Conditional Specification:</strong></li> </ul> \[u_i \mid \mathbf{u}_{-i}\sim \mathcal{N} \left( \frac{\sum_{j \in \text{ne}(i)} u_j}{n_i}, \frac{\tau^2}{n_i} \right)\] <ul> <li> <strong>Mean:</strong> The conditional expectation of an area’s risk is the average of its neighbors’ risks.</li> <li> <strong>Variance:</strong> Variance is inversely proportional to the number of neighbors (). Areas with more neighbors have lower variance (more information).</li> <li> <strong>Precision Matrix:</strong> The joint distribution is an improper multivariate normal where the precision matrix corresponds to the <strong>Graph Laplacian</strong>. This structure shrinks the random effect of sparse regions toward the local mean, stabilizing inference.</li> </ul> <h3 id="4-model-structure-what-we-are-estimating">4. Model Structure (what we are estimating)</h3> <p>Recall that the BYM model splits the log-risk ($\eta_i$) into covariates, an unstructured random effect ($v_i$), and a structured spatial effect ($u_i$).</p> <ul> <li> \[Y_i \sim \text{Poisson}(\lambda_i)\] </li> <li> \[\log(\lambda_i) = \log(E_i) + \eta_i\] </li> <li> \[\eta_i = \alpha + \mathbf{X}_i\beta + u_i + v_i\] <ul> <li>$\beta$: Regression coefficients (Fixed)</li> <li>$v_i$: Unstructured noise (Normal i.i.d)</li> <li>$u_i$: Structured spatial noise (CAR prior)</li> <li>$\tau_v, \tau_u$: Precision (inverse variance) hyperparameters for the random effects.</li> </ul> </li> </ul> <h4 id="5-the-sampling-process-how-we-estimate-it-iteratively">5. the Sampling Process (how we estimate it iteratively).</h4> <p>The goal is to Monte Carlo sample from the joint posterior distribution, allowing us to calculate means, credible intervals, and risk estimates. However, given the data and priors, we typically only know the posterior <strong>up to a constant of proportionality</strong>.</p> <p><strong>Markov Chain Monte Carlo (MCMC)</strong> is a method designed to sample from a probability distribution using only this unnormalized information. It works by constructing a ‘Markov Chain’, a stochastic process that only depends on the last step information, to explore the parameter space. The process relies on a <strong>proposal distribution</strong> to suggest a new candidate location based on the current one. A decision rule (typically Metropolis-Hastings) then evaluates this suggestion by comparing the likelihood ratio of the two locations. By accepting moves to higher probability areas more often than moves to lower ones, the walker naturally spends more time in areas of high probability, and its history forms a representative sample of the posterior.</p> <p>The <strong>Gibbs sampler</strong> is an MCMC method often used for complex hierarchical models. Instead of updating all parameters at once—which is difficult with many variables—it updates them one by one. It cycles through the list, asking: <em>“What is the likely value of Parameter A, assuming B and C are currently fixed?”</em> This is effective for clustered structure where indicators for group A and B are independent. However, Gibbs sampling struggles with <strong>spatial models</strong> because neighboring regions are highly correlated. Think of it like a three-legged race: Region A cannot move far unless Region B moves, but Gibbs holds B fixed while updating A. This forces the sampler to take tiny, inefficient steps, leading to <strong>slow mixing</strong> and the “snake-like” trace plots you want to avoid. (the “trace plot snake”).</p> <p>So we <strong>Hamiltonian Monte Carlo (HMC)</strong>, not Gibbs. HMC works on the principle of <strong>Random Kick + Gradient Steering</strong>. We give the sampler a random burst of momentum (the kick) to ensure it explores, but then we use the gradient of the posterior (the steering) to guide that momentum through the high-probability regions. Standard MCMC (Metropolis-Hastings) is a blind hiker taking random steps. He bumps into walls and gets rejected constantly. HMC uses the <strong>Gradient Steering</strong> to “see” the shape of the mountain. It flows <em>around</em> obstacles rather than bumping into them. Also, in a correlated “narrow canyon,” a zig-zags hiker can easily get stuck.The HMC sled uses its <strong>momentum</strong> to slide smoothly along the canyon floor, traversing long distances in a single update.</p> <p>Here is the <strong>Data Sources</strong> section, structured to highlight the diversity of the inputs and the spatial harmonization required.</p> <h2 id="part-2-data-sources">Part 2: Data Sources</h2> <h3 id="1-outcome-variable-cancer-incidence">1. Outcome Variable: Cancer Incidence</h3> <ul> <li> <strong>Source:</strong> New York State Cancer Registry and Cancer Statistics (https://www.health.ny.gov/statistics/cancer/registry/)</li> <li> <strong>Variable:</strong> Cancer Incidence by Region (2005–2009).</li> <li> <strong>Granularity:</strong> “DOH Regions”</li> </ul> <h3 id="2-predictor-socioeconomic-status-ses">2. Predictor: Socioeconomic Status (SES)</h3> <ul> <li> <strong>Source:</strong> New York State Cancer Registry and Cancer Statistics (https://www.health.ny.gov/statistics/cancer/registry/)</li> <li> <strong>Variable:</strong> Income, Education levels… (2005–2009).</li> <li> <strong>Granularity:</strong> “DOH Regions”</li> </ul> <h3 id="3-predictor-environmental-pollution">3. Predictor: Environmental Pollution</h3> <ul> <li> <strong>Source:</strong> EPA National-Scale Air Toxics Assessment (NATA), 2005 Edition (https://www.epa.gov/national-air-toxics-assessment/2005-national-air-toxics-assessment).</li> <li> <strong>Granularity:</strong> Census Tract.</li> <li> <strong>Variables Used:</strong>: <strong>Total Cancer Risk:</strong> </li> </ul> <p>Extracted from legacy Microsoft Access (<code class="language-plaintext highlighter-rouge">.mdb</code>) archives.</p> <h3 id="4-predictor-family-structure">4. Predictor: Family Structure</h3> <ul> <li> <p><strong>Source:</strong> U.S. Census Bureau American Community Survey (ACS). Used Census package in python to use API. It requries an API key, which can be obtained from https://api.census.gov/data/key_signup.html</p> </li> <li> <strong>Granularity:</strong> block, smaller than census tract.</li> <li> <strong>Variables Used:</strong>: Percentage of the population aged 15+ currently divorced, computed from three variables</li> </ul> <h2 id="part-2-real-data-challenge">Part 2: Real data challenge</h2> <h3 id="1-mismatched-spatial-granularities">1. Mismatched Spatial Granularities</h3> <p>A major engineering hurdle was integrating mismatched spatial granularities: our outcome variable (Cancer Incidence) and SES data were aggregated to custom “DOH Regions”, which is coarser with the standard Census Tract (EPA) and finer than Block Group (ACS) levels of our predictor variables. To resolve this, I built a custom <strong>“down-scale and re-aggregate”</strong> pipeline that first broadcasted coarse Tract-level data down to constituent Block Groups, then re-aggregated all metrics up to the target DOH Region level using a precise definition file, successfully harmonizing disparate government datasets without losing spatial fidelity.</p> <h3 id="2-scalability">2. Scalability</h3> <p>Even after excluding missing data, fitting a spatial random effect model on 16,000 units remained computationally prohibitive for HMC. To address this, I filtered the dataset to focus specifically on Manhattan, drastically reducing the sample size to approximately 1,000 units.”</p> <h2 id="part-3-code-implementation-explanation">Part 3: Code Implementation Explanation</h2> <p>The implementation is split into a Python script (data processing &amp; interface) and a Stan file (statistical model).</p> <h3 id="prelim-packages">Prelim: packages</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">geopandas</span> <span class="k">as</span> <span class="n">gpd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">libpysal</span>
<span class="kn">from</span> <span class="n">cmdstanpy</span> <span class="kn">import</span> <span class="n">CmdStanModel</span><span class="p">,</span> <span class="n">install_cmdstan</span>
<span class="kn">from</span> <span class="n">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">factorized</span>
<span class="kn">import</span> <span class="n">scipy.sparse</span> <span class="k">as</span> <span class="n">sp</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># --- CONFIGURATION ---
</span><span class="n">BASE_DIR</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/content/drive/MyDrive/spatial</span><span class="sh">"</span>
<span class="n">NYS_DIR</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_DIR</span><span class="si">}</span><span class="s">/NYS_Cancer</span><span class="sh">"</span>
<span class="n">CANCER_TYPE</span> <span class="o">=</span> <span class="sh">'</span><span class="s">BREAST</span><span class="sh">'</span> 
<span class="n">TARGET_COUNTY</span> <span class="o">=</span> <span class="sh">'</span><span class="s">061</span><span class="sh">'</span>  <span class="c1"># '061' = Manhattan (New York County). Set to None for full state.
</span>
<span class="c1"># --- 0. INSTALL CMDSTAN (If needed) ---
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">cmdstanpy</span>
    <span class="n">cmdstanpy</span><span class="p">.</span><span class="nf">cmdstan_path</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Installing CmdStan (C++ backend)...</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">install_cmdstan</span><span class="p">()</span>


</code></pre></div></div> <h3 id="block-1-helper-functions--setup">Block 1: Helper Functions &amp; Setup</h3> <p>We define helper functions to handle legacy data formats (Microsoft Access <code class="language-plaintext highlighter-rouge">.mdb</code>) and standard settings.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ==========================================
# 1. HELPER FUNCTIONS
# ==========================================
</span>
<span class="k">def</span> <span class="nf">read_mdb_table</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Exports a specific table from a Microsoft Access (.mdb) file to pandas.</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">([</span><span class="sh">'</span><span class="s">mdb-export</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--version</span><span class="sh">'</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">mdbtools not installed. Run </span><span class="sh">'</span><span class="s">!apt-get install -y mdbtools</span><span class="sh">'</span><span class="s"> first.</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">mdb-export</span><span class="sh">'</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">table_name</span><span class="p">]</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nc">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span>
</code></pre></div></div> <p><strong>Explanation:</strong> This function acts as a bridge. Since Python cannot natively read older <code class="language-plaintext highlighter-rouge">.mdb</code> files on Linux/Colab, this function calls a system command (<code class="language-plaintext highlighter-rouge">mdb-export</code>) to extract the requested table into a CSV format in memory, which <code class="language-plaintext highlighter-rouge">pandas</code> can then read.</p> <h3 id="block-2--data-processing-steps">Block 2 : DATA PROCESSING STEPS</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ==========================================
# 2. DATA PROCESSING STEPS
# ==========================================
</span>
<span class="k">def</span> <span class="nf">load_and_prep_main_data</span><span class="p">(</span><span class="n">county_fips</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Loads SES and Cancer shapefiles.
    If county_fips is provided (e.g., </span><span class="sh">'</span><span class="s">061</span><span class="sh">'</span><span class="s">), filters the map to that county only.
    </span><span class="sh">"""</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">--- 1. Loading Spatial Data ---</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Load Crosswalk to identify which Regions belong to the target County
</span>    <span class="n">crosswalk_path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NYS_DIR</span><span class="si">}</span><span class="s">/BlockGroup_Crosswalk_region.dbf</span><span class="sh">"</span>
    <span class="n">df_crosswalk</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nf">read_file</span><span class="p">(</span><span class="n">crosswalk_path</span><span class="p">)</span>
    <span class="n">df_crosswalk</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_crosswalk</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    
    <span class="c1"># Extract County FIPS from GEOID10 (String: State(2) + County(3) + ...)
</span>    <span class="c1"># NY is '36'. So we look at chars 2:5.
</span>    <span class="n">df_crosswalk</span><span class="p">[</span><span class="sh">'</span><span class="s">CountyFIPS</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_crosswalk</span><span class="p">[</span><span class="sh">'</span><span class="s">GEOID10</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="nf">zfill</span><span class="p">(</span><span class="mi">12</span><span class="p">).</span><span class="nb">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
    
    <span class="n">valid_regions</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">county_fips</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Filtering dataset to County FIPS: </span><span class="si">{</span><span class="n">county_fips</span><span class="si">}</span><span class="s"> (Manhattan)...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df_crosswalk</span><span class="p">[</span><span class="n">df_crosswalk</span><span class="p">[</span><span class="sh">'</span><span class="s">CountyFIPS</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">county_fips</span><span class="p">]</span>
        <span class="n">valid_regions</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s"> -&gt; Retaining </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">valid_regions</span><span class="p">)</span><span class="si">}</span><span class="s"> regions.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Load Shapefiles
</span>    <span class="n">ses_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nf">read_file</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NYS_DIR</span><span class="si">}</span><span class="s">/NYS_SES_Data_region.shp</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">cancer_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nf">read_file</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NYS_DIR</span><span class="si">}</span><span class="s">/NYSCancer_region.shp</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">ses_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ses_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">cancer_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cancer_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    
    <span class="c1"># Apply Filter
</span>    <span class="k">if</span> <span class="n">valid_regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ses_gdf</span> <span class="o">=</span> <span class="n">ses_gdf</span><span class="p">[</span><span class="n">ses_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">].</span><span class="nf">isin</span><span class="p">(</span><span class="n">valid_regions</span><span class="p">)]</span>
        <span class="n">cancer_gdf</span> <span class="o">=</span> <span class="n">cancer_gdf</span><span class="p">[</span><span class="n">cancer_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">].</span><span class="nf">isin</span><span class="p">(</span><span class="n">valid_regions</span><span class="p">)]</span>

    <span class="c1"># Merge SES data into the Cancer Geometry
</span>    <span class="n">gdf</span> <span class="o">=</span> <span class="n">cancer_gdf</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">ses_gdf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="sh">'</span><span class="s">geometry</span><span class="sh">'</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">inner</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gdf</span>

<span class="k">def</span> <span class="nf">process_divorce_data</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">crosswalk_gdf</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">--- 2. Processing Divorce Data ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">tract_path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_DIR</span><span class="si">}</span><span class="s">/NY_Tract_Divorce.csv</span><span class="sh">"</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">tract_path</span><span class="p">):</span> <span class="k">return</span> <span class="bp">None</span>

    <span class="n">df_tracts</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">tract_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">TRACT_GEOID</span><span class="sh">'</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
    
    <span class="c1"># Filter Crosswalk to match current GDF regions
</span>    <span class="n">active_regions</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()</span>
    <span class="n">crosswalk_prep</span> <span class="o">=</span> <span class="n">crosswalk_gdf</span><span class="p">[</span><span class="n">crosswalk_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">].</span><span class="nf">isin</span><span class="p">(</span><span class="n">active_regions</span><span class="p">)].</span><span class="nf">copy</span><span class="p">()</span>
    
    <span class="n">crosswalk_prep</span><span class="p">[</span><span class="sh">'</span><span class="s">TRACT_GEOID</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">crosswalk_prep</span><span class="p">[</span><span class="sh">'</span><span class="s">GEOID10</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="nf">zfill</span><span class="p">(</span><span class="mi">12</span><span class="p">).</span><span class="nb">str</span><span class="p">[:</span><span class="mi">11</span><span class="p">]</span>
    
    <span class="n">merged_bg</span> <span class="o">=</span> <span class="n">crosswalk_prep</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">df_tracts</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">TRACT_GEOID</span><span class="sh">'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">divorce_agg</span> <span class="o">=</span> <span class="n">merged_bg</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">)[[</span><span class="sh">'</span><span class="s">divorce_rate</span><span class="sh">'</span><span class="p">]].</span><span class="nf">mean</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">divorce_agg</span>

<span class="k">def</span> <span class="nf">process_pollution_data</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">crosswalk_gdf</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">--- 3. Processing Pollution (NATA 2005) ---</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">mdb_path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">BASE_DIR</span><span class="si">}</span><span class="s">/US_NATA05_V4_srcrisk_bytract.mdb</span><span class="sh">"</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">mdb_path</span><span class="p">):</span> <span class="k">return</span> <span class="bp">None</span>

    <span class="c1"># Read MDB
</span>    <span class="n">table_name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">US_NATA05_srcrisk_pollbkdn_bytract_hapcat_25Jan11</span><span class="sh">'</span>
    <span class="n">df_nata</span> <span class="o">=</span> <span class="nf">read_mdb_table</span><span class="p">(</span><span class="n">mdb_path</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
    
    <span class="c1"># Construct ID
</span>    <span class="n">df_nata</span><span class="p">[</span><span class="sh">'</span><span class="s">TRACT_GEOID</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_nata</span><span class="p">[</span><span class="sh">'</span><span class="s">FIPS</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="nf">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> 
                              <span class="n">df_nata</span><span class="p">[</span><span class="sh">'</span><span class="s">TRACT</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="nf">zfill</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    
    <span class="c1"># Filter NY
</span>    <span class="n">df_nata</span> <span class="o">=</span> <span class="n">df_nata</span><span class="p">[</span><span class="n">df_nata</span><span class="p">[</span><span class="sh">'</span><span class="s">TRACT_GEOID</span><span class="sh">'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">36</span><span class="sh">'</span><span class="p">)].</span><span class="nf">copy</span><span class="p">()</span>
    
    <span class="c1"># Calculate Risk
</span>    <span class="n">risk_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Point Cancer Risk</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Nonpoint Cancer Risk</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Onroad Cancer Risk</span><span class="sh">'</span><span class="p">,</span> 
                 <span class="sh">'</span><span class="s">Nonroad Cancer Risk</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Background Cancer Risk</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">valid_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">risk_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_nata</span><span class="p">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">df_nata</span><span class="p">[</span><span class="sh">'</span><span class="s">Cancer_Risk</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nata</span><span class="p">[</span><span class="n">valid_cols</span><span class="p">].</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Merge using Crosswalk
</span>    <span class="n">active_regions</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()</span>
    <span class="n">crosswalk_prep</span> <span class="o">=</span> <span class="n">crosswalk_gdf</span><span class="p">[</span><span class="n">crosswalk_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">].</span><span class="nf">isin</span><span class="p">(</span><span class="n">active_regions</span><span class="p">)].</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">crosswalk_prep</span><span class="p">[</span><span class="sh">'</span><span class="s">TRACT_GEOID</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">crosswalk_prep</span><span class="p">[</span><span class="sh">'</span><span class="s">GEOID10</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="nf">zfill</span><span class="p">(</span><span class="mi">12</span><span class="p">).</span><span class="nb">str</span><span class="p">[:</span><span class="mi">11</span><span class="p">]</span>
    
    <span class="n">merged</span> <span class="o">=</span> <span class="n">crosswalk_prep</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">df_nata</span><span class="p">[[</span><span class="sh">'</span><span class="s">TRACT_GEOID</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Cancer_Risk</span><span class="sh">'</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">TRACT_GEOID</span><span class="sh">'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">pollution_agg</span> <span class="o">=</span> <span class="n">merged</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">)[[</span><span class="sh">'</span><span class="s">Cancer_Risk</span><span class="sh">'</span><span class="p">]].</span><span class="nf">mean</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pollution_agg</span>
</code></pre></div></div> <p><strong>Explanation:</strong></p> <ol> <li> <strong>Shapefiles:</strong> Loads the Cancer geometry and Socioeconomic (SES) data.</li> <li> <strong>String Casting:</strong> Critical step. It converts <code class="language-plaintext highlighter-rouge">DOHREGION</code> to a string to ensure that IDs like <code class="language-plaintext highlighter-rouge">"05"</code> don’t become integer <code class="language-plaintext highlighter-rouge">5</code>, which would break the merge.</li> <li> <strong>Merge:</strong> Combines the two datasets into a single GeoDataFrame (<code class="language-plaintext highlighter-rouge">gdf</code>).</li> </ol> <h3 id="block-3-preprocessing--data">Block 3: PreProcessing Data</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ==========================================
# 3. MAIN WORKFLOW
# ==========================================
</span>
<span class="c1"># A. Load &amp; Filter Data (Manhattan Only)
</span><span class="n">gdf</span> <span class="o">=</span> <span class="nf">load_and_prep_main_data</span><span class="p">(</span><span class="n">county_fips</span><span class="o">=</span><span class="n">TARGET_COUNTY</span><span class="p">)</span>

<span class="c1"># Load Crosswalk (needed for variables)
</span><span class="n">crosswalk_path</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">NYS_DIR</span><span class="si">}</span><span class="s">/BlockGroup_Crosswalk_region.dbf</span><span class="sh">"</span>
<span class="n">df_crosswalk</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nf">read_file</span><span class="p">(</span><span class="n">crosswalk_path</span><span class="p">)</span>
<span class="n">df_crosswalk</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_crosswalk</span><span class="p">[</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># B. Process Variables
</span><span class="n">divorce_agg</span> <span class="o">=</span> <span class="nf">process_divorce_data</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">df_crosswalk</span><span class="p">)</span>
<span class="n">pollution_agg</span> <span class="o">=</span> <span class="nf">process_pollution_data</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">df_crosswalk</span><span class="p">)</span>

<span class="c1"># C. Merge &amp; Clean
</span><span class="k">if</span> <span class="n">divorce_agg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">divorce_agg</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">divorce_rate</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">divorce_rate</span><span class="sh">'</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">divorce_rate</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">())</span>

<span class="k">if</span> <span class="n">pollution_agg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">pollution_agg</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">DOHREGION</span><span class="sh">'</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">Cancer_Risk</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">Cancer_Risk</span><span class="sh">'</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">Cancer_Risk</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">())</span>
    <span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">log_cancer_risk</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">Cancer_Risk</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># D. Feature Engineering
</span><span class="n">y_col</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="s">O</span><span class="si">{</span><span class="n">CANCER_TYPE</span><span class="si">}</span><span class="sh">'</span>
<span class="n">e_col</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="s">E</span><span class="si">{</span><span class="n">CANCER_TYPE</span><span class="si">}</span><span class="sh">'</span>

<span class="c1"># Filter valid rows (Expected &gt; 0)
</span><span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[(</span><span class="n">gdf</span><span class="p">[</span><span class="n">e_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">y_col</span><span class="p">].</span><span class="nf">notna</span><span class="p">())].</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">poverty_rate</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">POVUNDER</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">POVUNDER</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">POVOVER</span><span class="sh">'</span><span class="p">])</span>
<span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">low_ed_rate</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">TOT_LT_HS</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">TOT_LT_HS</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">TOT_HSPLUS</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div> <p><strong>Explanation:</strong> <strong>spatial mismatch</strong> between the available divorce data (block) and the model units (Cancer Regions).</p> <ol> <li> <strong>Crosswalk:</strong> Uses a lookup table to map standard Census IDs (<code class="language-plaintext highlighter-rouge">TRACT_GEOID</code>) to custom Cancer Region IDs (<code class="language-plaintext highlighter-rouge">DOHREGION</code>).</li> <li> <strong>Imputation:</strong> Assigns the divorce rate of a Tract to all Block Groups inside it.</li> <li> <strong>Aggregation:</strong> Averages the divorce rates of all block groups within a specific <code class="language-plaintext highlighter-rouge">DOHREGION</code> to create a single predictor value for that region.</li> </ol> <p><strong>spatial mismatch</strong> between the available polution data (Census Tracts) and the model units (Cancer Regions).</p> <ol> <li> <strong>Extraction:</strong> Pulls the “Cancer Risk” table from the EPA NATA 2005 database.</li> <li> <strong>Summation:</strong> Calculates <code class="language-plaintext highlighter-rouge">Total Cancer Risk</code> by summing components (Point source + On-road + Non-road + Background). This creates a cumulative risk score.</li> <li> <strong>Aggregation:</strong> Similar to the divorce block, it maps these Tract-level risk scores to the custom Cancer Regions using the crosswalk.</li> </ol> <p><strong>Feature Engineering</strong></p> <h3 id="block-4--graph-construction">Block 4: Graph Construction</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># E. Prepare Stan Data
# Standardize Predictors
</span><span class="n">cols_to_use</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">poverty_rate</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">low_ed_rate</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">divorce_rate</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">log_cancer_risk</span><span class="sh">'</span><span class="p">]</span>
<span class="n">X_matrix</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_use</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gdf</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Fill NaNs before standardizing
</span>        <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">mean</span><span class="p">())</span>
        <span class="n">scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nf">std</span><span class="p">()</span>
        <span class="n">X_matrix</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">scaled</span><span class="p">)</span>
<span class="n">X_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">column_stack</span><span class="p">(</span><span class="n">X_matrix</span><span class="p">)</span>

<span class="c1"># Build Graph
</span><span class="n">w</span> <span class="o">=</span> <span class="n">libpysal</span><span class="p">.</span><span class="n">weights</span><span class="p">.</span><span class="n">Queen</span><span class="p">.</span><span class="nf">from_dataframe</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
<span class="k">if</span> <span class="n">w</span><span class="p">.</span><span class="n">islands</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dropping </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">islands</span><span class="p">)</span><span class="si">}</span><span class="s"> islands...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">islands</span><span class="p">).</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">libpysal</span><span class="p">.</span><span class="n">weights</span><span class="p">.</span><span class="n">Queen</span><span class="p">.</span><span class="nf">from_dataframe</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
    <span class="c1"># Re-standardize X needed if rows dropped? Ideally yes, but skipping for brevity here.
</span>
<span class="c1"># Calculate Scaling Factor (Fast Eigen Method)
</span><span class="n">adj_sparse</span> <span class="o">=</span> <span class="n">w</span><span class="p">.</span><span class="n">sparse</span>
<span class="n">degrees</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">adj_sparse</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)).</span><span class="nf">flatten</span><span class="p">()</span>
<span class="n">Q_sparse</span> <span class="o">=</span> <span class="n">sp</span><span class="p">.</span><span class="nf">diags</span><span class="p">(</span><span class="n">degrees</span><span class="p">)</span> <span class="o">-</span> <span class="n">adj_sparse</span>
<span class="c1"># Solve for diagonals (Approximate/Fast method)
</span><span class="n">Q_reg</span> <span class="o">=</span> <span class="n">Q_sparse</span> <span class="o">+</span> <span class="n">sp</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span>
<span class="n">solve</span> <span class="o">=</span> <span class="nf">factorized</span><span class="p">(</span><span class="n">Q_reg</span><span class="p">.</span><span class="nf">tocsc</span><span class="p">())</span>
<span class="n">diag_inv</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="nf">solve</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="n">i</span><span class="p">).</span><span class="nf">flatten</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">n</span><span class="p">)])</span>
<span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">diag_inv</span><span class="p">)))</span>
</code></pre></div></div> <p><strong>Explanation:</strong></p> <ol> <li> <strong>Rates:</strong> Converts raw counts (e.g., “Population in Poverty”) into rates (percentage) to make them comparable across regions.</li> <li> <strong>Log Transform:</strong> Applied to the Pollution Risk variable because such data is usually highly skewed (a few areas have massive pollution). The log scale linearizes the relationship.</li> <li> <strong>Adjacency Graph:</strong> Uses <code class="language-plaintext highlighter-rouge">libpysal</code> to define who is a “neighbor” (sharing a boundary).</li> <li> <strong>Scaling Factor:</strong> This is unique to <strong>BYM2</strong>. It calculates a geometric scaling factor from the graph Laplacian. This ensures that the variance parameter has the same interpretation regardless of the graph structure (e.g., whether the map is of New York or Texas).</li> </ol> <h3 id="block-6-the-stan-model-bym2_modelstan">Block 6: The Stan Model (<code class="language-plaintext highlighter-rouge">bym2_model.stan</code>)</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Prepare Stan Data Dictionary
</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">n</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">w</span><span class="p">.</span><span class="n">neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">node1</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">node2</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">stan_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">N</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">),</span>
    <span class="sh">'</span><span class="s">N_edges</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">node1</span><span class="p">),</span>
    <span class="sh">'</span><span class="s">node1</span><span class="sh">'</span><span class="p">:</span> <span class="n">node1</span><span class="p">,</span> <span class="sh">'</span><span class="s">node2</span><span class="sh">'</span><span class="p">:</span> <span class="n">node2</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="n">y_col</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">).</span><span class="nf">tolist</span><span class="p">(),</span>
    <span class="sh">'</span><span class="s">log_offset</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">e_col</span><span class="p">]).</span><span class="nf">tolist</span><span class="p">(),</span>
    <span class="sh">'</span><span class="s">K</span><span class="sh">'</span><span class="p">:</span> <span class="n">X_matrix</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">:</span> <span class="n">X_matrix</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">scaling_factor</span><span class="sh">'</span><span class="p">:</span> <span class="n">scaling_factor</span>
<span class="p">}</span>

<span class="c1"># --- 4. RUN MODEL ---
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Running BYM2 Model on </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="s"> Regions (Manhattan)...</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Write Stan File (Optimized GLM version)
</span><span class="n">bym_code</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
data {
  int&lt;lower=0&gt; N; int&lt;lower=0&gt; N_edges;
  array[N_edges] int&lt;lower=1, upper=N&gt; node1;
  array[N_edges] int&lt;lower=1, upper=N&gt; node2;
  array[N] int&lt;lower=0&gt; Y; vector[N] log_offset;
  int&lt;lower=1&gt; K; matrix[N, K] X; real&lt;lower=0&gt; scaling_factor;
}
parameters {
  real alpha; vector[K] beta;
  real&lt;lower=0&gt; sigma; real&lt;lower=0, upper=1&gt; rho;
  vector[N] theta; vector[N] phi;
}
transformed parameters {
  vector[N] convolved_re;
  convolved_re = sigma * (sqrt(rho) * phi + sqrt(1 - rho) * theta);
}
model {
  alpha ~ normal(0, 1.0); beta ~ normal(0, 1.0);
  sigma ~ normal(0, 1.0); rho ~ beta(0.5, 0.5); theta ~ normal(0, 1.0);
  target += -0.5 * dot_self(phi[node1] - phi[node2]);
  sum(phi) ~ normal(0, 0.001 * N);
  Y ~ poisson_log_glm(X, log_offset + alpha + convolved_re, beta);
}
generated quantities {
  vector[N] relative_risk = exp(alpha + X * beta + convolved_re);
}
</span><span class="sh">"""</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">bym2_model.stan</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">bym_code</span><span class="p">)</span>
</code></pre></div></div> <p><strong>Explanation:</strong></p> <ol> <li> <strong><code class="language-plaintext highlighter-rouge">target += ...</code></strong>: This line implements the <strong>ICAR (Intrinsic Conditional Autoregressive)</strong> prior. It penalizes differences between neighbors (<code class="language-plaintext highlighter-rouge">phi[node1] - phi[node2]</code>), forcing the spatial random effects to be smooth.</li> <li> <strong><code class="language-plaintext highlighter-rouge">sum(phi) ~ ...</code></strong>: A constraint to ensure the spatial effects sum to zero. This is necessary for the model to be identifiable (otherwise the intercept <code class="language-plaintext highlighter-rouge">alpha</code> and the random effects <code class="language-plaintext highlighter-rouge">phi</code> would be confounded).</li> <li> <strong><code class="language-plaintext highlighter-rouge">poisson_log</code></strong>: The likelihood function described in Part 1. It links the observed counts to the linear predictor via the log function.</li> </ol> <h3 id="block-7-inference">Block 7: Inference</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

<span class="c1"># Compile &amp; Sample
</span><span class="n">model</span> <span class="o">=</span> <span class="nc">CmdStanModel</span><span class="p">(</span><span class="n">stan_file</span><span class="o">=</span><span class="sh">'</span><span class="s">bym2_model.stan</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">stan_data</span><span class="p">,</span> 
    <span class="n">iter_sampling</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">iter_warmup</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span> <span class="c1"># Faster settings
</span>    <span class="n">parallel_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show_console</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>

<span class="c1"># --- 5. RESULTS ---
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- RESULTS ---</span><span class="sh">"</span><span class="p">)</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">fit</span><span class="p">.</span><span class="nf">summary</span><span class="p">()</span>
<span class="n">beta_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">.</span><span class="n">index</span> <span class="k">if</span> <span class="sh">'</span><span class="s">beta</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
<span class="nf">print</span><span class="p">(</span><span class="n">summary</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">beta_rows</span><span class="p">,</span> <span class="p">[</span><span class="sh">'</span><span class="s">Mean</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">5%</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">95%</span><span class="sh">'</span><span class="p">]])</span>

<span class="c1"># Map
</span><span class="n">gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">RR</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="p">.</span><span class="nf">stan_variable</span><span class="p">(</span><span class="sh">'</span><span class="s">relative_risk</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">gdf</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="sh">'</span><span class="s">RR</span><span class="sh">'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdYlBu_r</span><span class="sh">'</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Manhattan </span><span class="si">{</span><span class="n">CANCER_TYPE</span><span class="si">}</span><span class="s"> Cancer Risk (modeled)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">--- HMC DIAGNOSTICS ---</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">fit</span><span class="p">.</span><span class="nf">diagnose</span><span class="p">())</span>
</code></pre></div></div> <p><strong>Explanation:</strong></p> <ol> <li> <strong>Sampling:</strong> Runs the Hamiltonian Monte Carlo (HCMC) algorithm to sample from the posterior distribution.</li> <li> <strong>Results:</strong> Extracts the <code class="language-plaintext highlighter-rouge">beta</code> coefficients. <ul> <li>If <code class="language-plaintext highlighter-rouge">beta</code> for Pollution is positive and its Credible Interval excludes zero, we conclude that higher pollution is associated with significantly higher cancer risk, even after controlling for poverty and spatial clustering. Here is a structured summary of the challenges we navigated during this project.</li> </ul> </li> </ol> <h1 id="result">Result</h1> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- RESULTS ---
             Mean        5%       95%
beta[1]  0.014177 -0.024948  0.053882
beta[2] -0.180270 -0.227835 -0.131878
beta[3] -0.020294 -0.047240  0.006532
beta[4]  0.023693 -0.005721  0.053664
</code></pre></div></div> <p>Only the education factor is significant.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2026 Jongmin Mun. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js"></script> <script defer src="/assets/js/common.js"></script> <script defer src="/assets/js/copy_code.js" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>